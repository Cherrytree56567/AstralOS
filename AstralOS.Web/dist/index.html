<!doctype html>
<html>
    <head>
        <title>AstralOS</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=SUSE+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.css">
        <link rel="stylesheet" href="style.css">
    </head>
    <body class="bg-ctp-crust flex flex-col m-[0px]" id="root">
        <div class="navbar relative bg-ctp-crust h-[50px] w-full flex items-center pl-[50px]">
            <a class="text-ctp-text no-underline font-bold" href="https://github.com/CherryTree56567/AstralOS">AstralOS</a>

            
        </div>
        <div class="container flex flex-col items-center justify-center text-center w-[65vw] mb-[1rem]">
            <br>
            <h1 class="text-ctp-text text-[3rem] mb-[1rem]">Astral OS</h1>
            <span class="text-ctp-text text-[1rem] p-[0.5rem]">AstralOS is a simple OS made in C++. It includes a lot of features, like a hybrid kernel (eventually) and a multi partition os. The code contains comments showing how everything works and which parts are from other sources. Here is a QEMU VM Powered By ktock/qemu-wasm to showcase the OS. It will take a while to load. <br><b>To run the demo, type in:</b></span>
            <span class="text-ctp-text text-[1rem] p-[0.5rem] code"><code>fs0:<br>cd efi/boot<br>BOOTX64.EFI</code></span>
        </div>
        <div class="term-container">
            <div class="tc rounded-tl-[7px] rounded-tr-[7px] rounded-br-[0px] rounded-bl-[0px] bg-ctp-surface0 flex p-[8px] items-center">
                <div class="dot bg-ctp-red"></div>
                <div class="dot bg-ctp-yellow"></div>
                <div class="dot bg-ctp-green"></div>
                <span class="text-[10px] text-ctp-text font-bold">ktock@qemu-wasm</span>
            </div>
            <div id="terminal">

            </div>
        </div>
        <script src="./coi-serviceworker.js"></script>
        <script src="./module.js"></script>
        <script src="./image/load-rootfs.js"></script>
        <script src="./image/load-uefi.js"></script>
        <script src="./image/load-rom.js"></script>
        <script src="./image/dist/stack.js"></script>
        <script type="module">
            import 'https://unpkg.com/xterm@5.3.0/lib/xterm.js';
            import 'https://unpkg.com/xterm-pty/index.js';
            import './module.js'
            import initEmscriptenModule from './image/out.js';

            const xterm = new Terminal();
            xterm.open(document.getElementById("terminal"));

            const { master, slave } = openpty();

            xterm.loadAddon(master);

            Module.pty = slave;

            const stackAddress = 'http://localhost:9999/';
            const stackWorkerFile = location.origin + "/AstralOS" + "/image/dist/stack-worker.js";
            const stackImage = location.origin  + "/AstralOS" + "/image/c2w-net-proxy.wasm.gzip";
            Module['websocket'] = {
                'url': stackAddress
            };
            Stack.Start(stackAddress, stackWorkerFile, stackImage, (cert) => {
                Module['preRun'].push((mod) => {
                    mod.FS.mkdir('/.wasmenv');
                    mod.FS.writeFile('/.wasmenv/proxy.crt', cert);
                });
                start();
            });

            function start() {
                (async () => {
                    const instance = await initEmscriptenModule(Module);
                    
                    var oldPoll = Module['TTY'].stream_ops.poll;
                    var pty = Module['pty'];
                    Module['TTY'].stream_ops.poll = function(stream, timeout){
                        if (!pty.readable) {
                            return (pty.readable ? 1 : 0) | (pty.writable ? 4 : 0);
                        }
                        return oldPoll.call(stream, timeout);
                    }
                })();
            }
        </script>
    </body>
</html>